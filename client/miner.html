<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ãƒã‚¤ãƒ‹ãƒ³ã‚°ä½“é¨“</title>
  
  
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      text-align: center;
      margin-top: 50px;
      background: linear-gradient(135deg, #f0f4f8, #d9e2ec);
      color: #333;
      line-height: 1.6;
    }

    h1, h2 {
      color: #007bff;
      margin-bottom: 20px;
      font-weight: 600;
    }

    h1 .fas {
      margin-right: 10px;
    }

    p {
      margin-bottom: 15px;
    }

    #gameScreen, #endScreen {
      background-color: #fff;
      padding: 30px;
      border-radius: 12px;
      box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
      max-width: 800px;
      margin: 30px auto;
      text-align: left;
    }

    #hashOutput {
      font-family: 'Cascadia Code', 'Consolas', 'Monaco', monospace;
      font-size: 0.95em;
      background-color: #f8f9fa;
      border: 1px solid #e9ecef;
      padding: 15px;
      border-radius: 8px;
      word-break: break-all;
      white-space: pre-wrap;
      margin-bottom: 20px;
      color: #555;
    }

    #ranking, #endRanking {
      margin-top: 40px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px;
      background-color: #fefefe;
      border-radius: 8px;
      overflow: hidden; /* è§’ä¸¸ã‚’é©ç”¨ã™ã‚‹ãŸã‚ã«å¿…è¦ */
    }

    th, td {
      border: 1px solid #dee2e6;
      padding: 12px;
      text-align: left;
    }

    th {
      background-color: #e9ecef;
      color: #495057;
      font-weight: 600;
    }

    tr:nth-child(even) {
      background-color: #f3f7fb;
    }

    tr:hover {
      background-color: #e2f0ff;
      transition: background-color 0.2s ease-in-out;
    }

    input[type="text"] {
      padding: 10px 15px;
      border: 1px solid #ced4da;
      border-radius: 6px;
      font-size: 1em;
      width: 200px;
      margin-right: 10px;
      box-sizing: border-box;
    }

    button {
      padding: 10px 20px;
      font-size: 1em;
      cursor: pointer;
      background-color: #007bff;
      color: white;
      border: none;
      border-radius: 6px;
      transition: background-color 0.2s ease-in-out, transform 0.1s ease-out;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      justify-content: center;
    }

    button:hover {
      background-color: #0056b3;
      transform: translateY(-1px);
    }

    button:active {
      background-color: #004085;
      transform: translateY(0);
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
      transform: none;
    }

    #statusMessage {
      font-weight: bold;
      color: #28a745;
      margin-bottom: 20px;
      font-size: 1.1em;
    }

    #winnerOutput, #finalWinnerOutput {
      font-size: 1.5em;
      color: #28a745;
      font-weight: bold;
      margin-top: 20px;
      text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.1);
    }

    .hidden {
      display: none;
    }
  </style>
  
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
  <h1><i class="fas fa-hammer"></i> ãƒã‚¤ãƒ‹ãƒ³ã‚°ä½“é¨“</h1>
  <p>
    ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ :
    <input type="text" id="username" placeholder="ã‚ãªãŸã®åå‰" value="guest" />
    <button id="connectBtn"><i class="fas fa-plug"></i> å†æ¥ç¶š</button>
  </p>
  <p id="statusMessage">ã‚µãƒ¼ãƒãƒ¼æœªæ¥ç¶š</p>

  <div id="gameScreen">
    <p>
      <button id="mineBtn" disabled><i class="fas fa-wrench"></i> ãƒãƒƒã‚·ãƒ¥è¨ˆç®— (1å›)</button>
    </p>
    <p id="hashOutput">ã“ã“ã«ãƒãƒƒã‚·ãƒ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™</p>
    <p id="winnerOutput"></p>

    <div id="ranking">
      <h2>æ­´ä»£ãƒ©ãƒ³ã‚­ãƒ³ã‚°ï¼ˆä¸Šä½10äººï¼‰</h2>
      <table>
        <thead>
          <tr>
            <th>é †ä½</th>
            <th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </th>
            <th>æ™‚é–“ (ç§’)</th>
            <th>ãƒãƒƒã‚·ãƒ¥å›æ•°</th>
          </tr>
        </thead>
        <tbody id="rankingBody">
          <tr><td colspan="4">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å¾…ã£ã¦ã„ã¾ã™...</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <div id="endScreen">
    <h2>ã‚²ãƒ¼ãƒ çµ‚äº†ï¼</h2>
    <p id="finalWinnerOutput"></p>
    <h3>ä»Šå›ã®å‚åŠ è€…ãƒ©ãƒ³ã‚­ãƒ³ã‚°</h3>
    <div id="endRanking">
      <table>
        <thead>
          <tr><th>é †ä½</th><th>ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ </th><th>æ™‚é–“ (ç§’)</th><th>ãƒãƒƒã‚·ãƒ¥å›æ•°</th></tr>
        </thead>
        <tbody id="endRankingBody">
          <tr><td colspan="4">ãƒ©ãƒ³ã‚­ãƒ³ã‚°ãƒ‡ãƒ¼ã‚¿ã‚’å¾…ã£ã¦ã„ã¾ã™...</td></tr>
        </tbody>
      </table>
    </div>
  </div>
  <script src="config.js"></script>

  <script>
    let ws;
    let nonce = 0;
    let baseData = '';
    let startTime = null;
    let gameActive = false;
    let currentPlayersProgress = new Map();

    // config.jsã‹ã‚‰èª­ã¿è¾¼ã‚“ã è¨­å®šã‚’ä½¿ã†
    const WS_URL = `ws://${SERVER_CONFIG.IP}:${SERVER_CONFIG.PORT}`;

    // Enterã‚­ãƒ¼ã®é•·æŠ¼ã—é˜²æ­¢ç”¨ãƒ•ãƒ©ã‚°
    let isEnterKeyDown = false; 
    
    // ãƒªãƒ­ãƒ¼ãƒ‰å¯¾ç­–ç”¨ã®å¤‰æ•°
    let hashesComputedSinceLastReport = 0; 
    const REPORT_INTERVAL_HASHES = 20; 
    let lastComputedHash = '';

    const usernameInput = document.getElementById('username');
    const connectButton = document.getElementById('connectBtn');
    const mineButton = document.getElementById('mineBtn');
    const hashOutput = document.getElementById('hashOutput');
    const winnerOutput = document.getElementById('winnerOutput');
    const statusMessage = document.getElementById('statusMessage');
    const rankingBody = document.getElementById('rankingBody');

    const gameScreen = document.getElementById('gameScreen');
    const endScreen = document.getElementById('endScreen');
    const finalWinnerOutput = document.getElementById('finalWinnerOutput');
    const endRankingBody = document.getElementById('endRankingBody');

    function showScreen(screenId) {
      gameScreen.style.display = 'none';
      endScreen.style.display = 'none';
      document.getElementById(screenId).style.display = 'block';
    }

    function connectToGame() {
      const name = usernameInput.value.trim();
      if (!name) {
        alert('ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
      }

      if (ws && ws.readyState !== WebSocket.CLOSED) {
        ws.close();
      }

      ws = new WebSocket(WS_URL);

      ws.onopen = () => {
        ws.send(JSON.stringify({ type: 'register', username: name }));
        statusMessage.textContent = `${name} ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸­ã€‚ã‚µãƒ¼ãƒãƒ¼ã‹ã‚‰ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã‚’å¾…æ©Ÿä¸­...`;
        mineButton.disabled = true;
        winnerOutput.textContent = '';
        hashOutput.textContent = 'ã“ã“ã«ãƒãƒƒã‚·ãƒ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
        currentPlayersProgress.clear();
        showScreen('gameScreen');
      };

      ws.onmessage = (event) => {
        const msg = JSON.parse(event.data);
        const currentUsername = usernameInput.value.trim();

        if (msg.type === 'state') {
          if (msg.state === 'mining') {
            statusMessage.textContent = `${currentUsername} ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸­ã€‚ãƒã‚¤ãƒ‹ãƒ³ã‚°ä¸­...`;
            gameActive = true;
            mineButton.disabled = false;
            if (!startTime) {
                startTime = Date.now();
            }
            winnerOutput.textContent = '';
            currentPlayersProgress.clear();
            showScreen('gameScreen');
          } else if (msg.state === 'idle') {
            statusMessage.textContent = `${currentUsername} ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸­ã€‚ã‚²ãƒ¼ãƒ é–‹å§‹ã‚’å¾…æ©Ÿä¸­...`;
            gameActive = false;
            mineButton.disabled = true;
            nonce = 0;
            baseData = '';
            startTime = null;
            hashesComputedSinceLastReport = 0;
            showScreen('gameScreen');
          } else if (msg.state === 'finished') {
            statusMessage.textContent = `${currentUsername} ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸­ã€‚ã‚²ãƒ¼ãƒ çµ‚äº†ã€‚`;
            gameActive = false;
            mineButton.disabled = true;
            nonce = 0;
            baseData = '';
            startTime = null;
            hashesComputedSinceLastReport = 0;
          }
        } else if (msg.type === 'countdown') {
          statusMessage.textContent = `${currentUsername} ã§ã‚¨ãƒ³ãƒˆãƒªãƒ¼ä¸­ã€‚ã‚²ãƒ¼ãƒ é–‹å§‹ã¾ã§: ${msg.secondsLeft} ç§’`;
          mineButton.disabled = true;
          nonce = 0;
          baseData = '';
          startTime = null;
          hashesComputedSinceLastReport = 0;
        } else if (msg.type === 'winner') {
          finalWinnerOutput.textContent = `ğŸ‰ å‹è€…ã¯ ${msg.winner.username} (${msg.winner.time}ç§’) ğŸ‰`;
          gameActive = false;
          mineButton.disabled = true;
          showScreen('endScreen');
          updateEndRanking(msg.allParticipants);
          hashesComputedSinceLastReport = 0;
        } else if (msg.type === 'ranking') {
          updateOverallRanking(msg.data);
        } else if (msg.type === 'game_reset') {
          statusMessage.textContent = `ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦ã‚¨ãƒ³ãƒˆãƒªãƒ¼ã—ã‚ˆã†ï¼`;
          mineButton.disabled = true;
          winnerOutput.textContent = '';
          hashOutput.textContent = 'ã“ã“ã«ãƒãƒƒã‚·ãƒ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
          nonce = 0;
          baseData = '';
          startTime = null;
          gameActive = false;
          currentPlayersProgress.clear();
          showScreen('gameScreen');
          updateEndRanking();
          hashesComputedSinceLastReport = 0;
        } else if (msg.type === 'game_start_info') {
            nonce = msg.nonce;
            baseData = msg.baseData;
            hashOutput.textContent = `åˆæœŸnonce: ${nonce}, baseData: ${baseData.substring(0, 10)}...`;
        } else if (msg.type === 'player_progress_update') {
          currentPlayersProgress.set(msg.username, {
            hashCount: msg.nonce
          });
        }
      };

      ws.onclose = () => {
        console.log('ã‚µãƒ¼ãƒãƒ¼ã¨ã®æ¥ç¶šãŒåˆ‡ã‚Œã¾ã—ãŸ');
        statusMessage.textContent = `ã‚µãƒ¼ãƒãƒ¼åˆ‡æ–­ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒãƒ¼ãƒ ã‚’å…¥åŠ›ã—ã¦å†æ¥ç¶šã—ã¦ãã ã•ã„ã€‚`;
        mineButton.disabled = true;
        gameActive = false;
        nonce = 0;
        baseData = '';
        startTime = null;
        winnerOutput.textContent = '';
        hashOutput.textContent = 'ã“ã“ã«ãƒãƒƒã‚·ãƒ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
        currentPlayersProgress.clear();
        hashesComputedSinceLastReport = 0; 
      };

      ws.onerror = (err) => {
        console.error('WebSocketã‚¨ãƒ©ãƒ¼:', err);
        statusMessage.textContent = `æ¥ç¶šã‚¨ãƒ©ãƒ¼ã€‚ã‚µãƒ¼ãƒãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚`;
        mineButton.disabled = true;
        gameActive = false;
        nonce = 0;
        baseData = '';
        startTime = null;
        winnerOutput.textContent = '';
        hashOutput.textContent = 'ã“ã“ã«ãƒãƒƒã‚·ãƒ¥ãŒè¡¨ç¤ºã•ã‚Œã¾ã™';
        currentPlayersProgress.clear();
        hashesComputedSinceLastReport = 0; 
      };
    }

    window.onload = () => {
      connectToGame();
    };

    connectButton.onclick = () => {
      connectToGame();
    };

    mineButton.onclick = async () => {
      await mine();
    };

    async function mine() {
      if (!gameActive || mineButton.disabled) {
        return;
      }
      
      const dataToHash = baseData + nonce;
      const hash = await sha256(dataToHash);
      lastComputedHash = hash; // è¨ˆç®—ã—ãŸãƒãƒƒã‚·ãƒ¥ã‚’æ¯å›ä¿æŒã™ã‚‹

      hashOutput.textContent = `nonce: ${nonce}, hash: ${hash.substring(0, 20)}...`;

      hashesComputedSinceLastReport++;

      // 20å›ã”ã¨ã«ã‚µãƒ¼ãƒãƒ¼ã«é€²æ—ã‚’å ±å‘Š
      if (hashesComputedSinceLastReport >= REPORT_INTERVAL_HASHES) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          ws.send(JSON.stringify({
            type: 'player_progress',
            nonce: nonce + 1, // æ¬¡ã«è¨ˆç®—ã™ã‚‹nonce
            hash: hash
          }));
          hashesComputedSinceLastReport = 0; // ã‚«ã‚¦ãƒ³ã‚¿ãƒ¼ã‚’ãƒªã‚»ãƒƒãƒˆ
        }
      }

      if (hash.startsWith('00')) {
        const timeTaken = ((Date.now() - startTime) / 1000).toFixed(2);
        ws.send(JSON.stringify({ type: 'win', time: timeTaken, hashCount: nonce + 1 }));
        mineButton.disabled = true;
        gameActive = false;
      }

      nonce++;
    }

    // Enterã‚­ãƒ¼ã®é•·æŠ¼ã—é˜²æ­¢
    document.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !usernameInput.matches(':focus') && gameActive && !mineButton.disabled) {
        event.preventDefault();
        
        if (isEnterKeyDown) {
          return;
        }
        
        isEnterKeyDown = true;
        mine();
      }
    });

    document.addEventListener('keyup', (event) => {
      if (event.key === 'Enter') {
        isEnterKeyDown = false;
      }
    });

    // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«é€²æ—ã‚’å ±å‘Šã™ã‚‹ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    window.addEventListener('beforeunload', () => {
      // ã‚²ãƒ¼ãƒ ä¸­ã§ã€ã‹ã¤æœªå ±å‘Šã®è¨ˆç®—ãŒã‚ã‚‹å ´åˆ
      if (gameActive && hashesComputedSinceLastReport > 0) {
        if (ws && ws.readyState === WebSocket.OPEN) {
          // send()ã¯éåŒæœŸã ãŒã€ãƒšãƒ¼ã‚¸ãŒé–‰ã˜ã‚‹å‰ã«é€ä¿¡ã‚’è©¦ã¿ã‚‹
          ws.send(JSON.stringify({
            type: 'player_progress',
            nonce: nonce, // æ¬¡ã«è¨ˆç®—ã™ã‚‹ã¹ãnonceã®å€¤(ã‚¤ãƒ³ã‚¯ãƒªãƒ¡ãƒ³ãƒˆæ¸ˆ)ã‚’é€ä¿¡
            hash: lastComputedHash
          }));
        }
      }
    });

    function updateOverallRanking(data) {
      rankingBody.innerHTML = '';

      if (!data || data.length === 0) {
        rankingBody.innerHTML = '<tr><td colspan="4">æ­´ä»£ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      data.forEach((row, i) => {
        const tr = document.createElement('tr');
        tr.innerHTML = `<td>${i + 1}</td><td>${row.username}</td><td>${row.time}</td><td>${row.hash_count ?? '-'}</td>`;
        rankingBody.appendChild(tr);
      });
    }

    function updateEndRanking(participantsData = null) {
      endRankingBody.innerHTML = '';

      if (!participantsData || participantsData.length === 0) {
        endRankingBody.innerHTML = '<tr><td colspan="4">ä»Šå›ã®å‚åŠ è€…ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</td></tr>';
        return;
      }

      participantsData.sort((a, b) => {
          if (a.time !== null && b.time === null) return -1;
          if (a.time === null && b.time !== null) return 1;
          if (a.time !== null && b.time !== null) {
              return a.time - b.time;
          }
          return b.hashCount - a.hashCount;
      });

      participantsData.forEach((row, i) => {
        const tr = document.createElement('tr');
        const rank = i + 1;
        const timeDisplay = row.time !== null ? row.time : '-';
        const hashCountDisplay = row.hashCount !== null ? row.hashCount : '-';

        tr.innerHTML = `
            <td>${rank}</td>
            <td>${row.username}</td>
            <td>${timeDisplay}</td>
            <td>${hashCountDisplay}</td>
        `;
        endRankingBody.appendChild(tr);

        if (row.isWinner) {
            tr.style.fontWeight = 'bold';
            tr.style.backgroundColor = '#e6ffe6';
        }
      });
    }

    // SHA256ãƒãƒƒã‚·ãƒ¥é–¢æ•°
    function sha256(str) {
      const buf = new TextEncoder('utf-8').encode(str);
      return crypto.subtle.digest('SHA-256', buf).then(hashBuffer => {
        // â˜…â˜…â˜… ã“ã“ã®ã‚¿ã‚¤ãƒ—ãƒŸã‚¹ã‚’ä¿®æ­£ã—ã¾ã—ãŸ (Uint84Array -> Uint8Array) â˜…â˜…â˜…
        const hashArray = Array.from(new Uint8Array(hashBuffer));
        return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
      });
    }
</script>
</body>
</html>